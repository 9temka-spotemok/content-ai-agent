"""
Реализация фреймворка DEEP IMPACT для анализа целевой аудитории
"""
from typing import Dict, List, Any, Optional
from enum import Enum

class PromptType(Enum):
    """Типы промптов из фреймворка"""
    INTERVIEW = "interview"  # Интервью-промты
    GENERATIVE = "generative"  # Генеративные промты
    DIRECT = "direct"  # Прямые промты

class DeepImpactFramework:
    """
    Фреймворк DEEP IMPACT для глубокого анализа целевой аудитории
    
    D - Desires and Dreams (Желания и Мечты)
    E - Emotions and Experiences (Эмоции и Опыт)
    E - Expectations and Evaluations (Ожидания и Оценки)
    P - Pain Points and Problems (Болевые точки и Проблемы)
    
    I - Insights and Intentions (Инсайты и Намерения)
    M - Motivations and Mindsets (Мотивации и Образ мышления)
    P - Perceptions and Preferences (Восприятие и Предпочтения)
    A - Aspirations and Actions (Стремления и Действия)
    C - Concerns and Challenges (Опасения и Вызовы)
    T - Triggers and Transformations (Триггеры и Трансформации)
    """
    
    def __init__(self):
        self.current_stage = "audit"
        self.data = {}
        self.hypotheses = {}
        
    def get_audit_prompts(self) -> Dict[str, str]:
        """Промпты для аудита исходных данных"""
        return {
            "business_context": """
Ты - опытный маркетинговый аналитик, проводящий глубинное интервью с клиентом 
для анализа его бизнеса и целевой аудитории. Твоя задача - собрать максимально 
полную информацию о контексте бизнеса, рыночной ситуации и доступных данных.

При работе с клиентом:
1. Задавай открытые вопросы, которые требуют развернутых ответов
2. После каждого ответа задавай 1-2 уточняющих вопроса, если информация неполная
3. Проявляй эмпатию и демонстрируй понимание бизнес-ситуации клиента
4. Работай по этапам, задавай вопросы постепенно
5. В завершение сделай краткое резюме полученной информации

Начни с вопроса о бизнес-нише и рыночном позиционировании.
""",
            "data_categorization": """
Теперь проведи инвентаризацию имеющихся данных. Классифицируй данные по 5 категориям:
1. Внутренние данные (CRM, аналитика сайта, история продаж)
2. Экспертные знания (опыт, интуиция команды)
3. Внешние данные (исследования рынка, отраслевые отчеты)
4. Неструктурированные данные (отзывы, комментарии, обратная связь)
5. Аналитические данные (предыдущие выводы об аудитории)

Оцени полноту и достоверность каждой категории (по шкале от 1 до 10).
""",
            "data_quality": """
Проанализируй качество собранных данных:
- Репрезентативность данных
- Достоверность источников
- Возможные смещения
- Критичные пробелы в информации

Предложи план сбора недостающих данных с минимальными затратами.
"""
        }
    
    def get_hypothesis_generation_prompts(self, level: str) -> Dict[str, str]:
        """
        Промпты для генерации гипотез на разных уровнях
        
        Args:
            level: "market", "niche", "audience", "segment", "pain", "task"
        """
        prompts = {
            "market": {
                "generate": """
Сгенерируй 20 вариантов перспективных рынков для бизнеса клиента.
Для каждого рынка укажи:
- Название рынка
- Размер и потенциал роста
- Конкурентную среду
- Барьеры входа
- Совместимость с продуктом клиента
""",
                "evaluate": """
Оцени каждую гипотезу рынка по 5 критериям (по шкале 1-10):
1. Размер рынка и потенциал роста
2. Совместимость с продуктом
3. Конкурентная среда
4. Доступность аудитории
5. Потенциал монетизации

Создай сравнительную таблицу ТОП-3 рынков.
""",
                "final_choice": """
Проведи финальный выбор рынка через интервью с клиентом.
Учти как анализ данных, так и интуицию клиента.
"""
            },
            "niche": {
                "generate": """
Сгенерируй 20 вариантов узких ниш внутри выбранного рынка.
Для каждой ниши укажи:
- Специфические характеристики
- Уникальные потребности
- Размер ниши
- Конкурентное позиционирование
""",
                "evaluate": """
Оцени каждую нишу по 5 критериям:
1. Острота потребности
2. Размер ниши
3. Готовность платить
4. Доступность для маркетинга
5. Потенциал роста
""",
                "final_choice": """
Проведи финальный выбор ниши через интервью.
"""
            },
            "audience": {
                "generate": """
Сгенерируй 20 вариантов потенциальных аудиторий.
Для каждой аудитории опиши:
- Демографические характеристики
- Психографический профиль
- Поведенческие паттерны
- Болевые точки
""",
                "evaluate": """
Оцени каждую аудиторию по 5 критериям:
1. Размер аудитории
2. Острота боли
3. Готовность к покупке
4. Доступность для коммуникации
5. Потенциал LTV
""",
                "final_choice": """
Проведи финальный выбор аудитории.
"""
            },
            "segment": {
                "generate": """
Сгенерируй 20 вариантов сегментов внутри выбранной аудитории.
Для каждого сегмента опиши:
- Уникальные характеристики
- Специфические потребности
- Поведенческие отличия
- Языковые паттерны
""",
                "evaluate": """
Оцени каждый сегмент по 5 критериям:
1. Острота специфической боли
2. Размер сегмента
3. Готовность платить
4. Легкость таргетинга
5. Потенциал конверсии
""",
                "final_choice": """
Проведи финальный выбор сегмента.
"""
            },
            "pain": {
                "generate": """
Сгенерируй 20 вариантов острых проблем выбранного сегмента.
Для каждой проблемы опиши:
- Суть проблемы
- Эмоциональное воздействие
- Частота возникновения
- Влияние на жизнь/бизнес
""",
                "focus": """
Выбери наиболее острую проблему по 5 критериям:
1. Интенсивность боли
2. Частота возникновения
3. Влияние на жизнь/бизнес
4. Готовность платить за решение
5. Эмоциональная значимость
""",
                "triggers": """
Проанализируй 20 ситуаций, когда боль обостряется.
Для каждой ситуации опиши:
- Контекст ситуации
- Эмоциональное состояние
- Триггеры обострения
- Поведенческие реакции
"""
            },
            "task": {
                "generate": """
Сгенерируй 10-12 вариантов неотложных задач в формате JTBD (Jobs To Be Done).
Формат: "Когда [ситуация], я хочу [желаемый результат], чтобы [мотивация]."

Каждая задача должна быть конкретной, измеримой и связанной с выбранной болью и сегментом аудитории.
""",
                "focus": """
Выбери наиболее приоритетную задачу по критериям:
1. Частота возникновения
2. Критичность для клиента
3. Готовность платить
4. Эмоциональная значимость
5. Потенциал решения продуктом
""",
                "triggers": """
Проанализируй 20 ситуаций, когда потребность в решении обостряется.
"""
            }
        }
        
        return prompts.get(level, {})
    
    def get_audience_expansion_prompts(self) -> Dict[str, str]:
        """Промпты для расширения понимания аудитории"""
        return {
            "deep_motivations": """
Проанализируй глубинные мотивы и стремления целевой аудитории.
Выяви фундаментальные причины возникновения боли.
""",
            "hidden_motivations": """
Выяви скрытые, неосознанные драйверы поведения аудитории.
""",
            "triggers_situations": """
Проанализируй триггеры и ситуации эмоционального пика.
""",
            "related_problems": """
Выяви сопутствующие проблемы и вторичные болевые точки.
""",
            "audience_language": """
Изучи аутентичный язык целевой аудитории.
Как они формулируют свои проблемы?
""",
            "internal_motivators": """
Выяви внутренние мотиваторы - мысли, побуждающие к действию.
""",
            "beliefs_attitudes": """
Проанализируй убеждения и установки, дающие надежду.
""",
            "negative_beliefs": """
Выяви негативные установки и блокирующие убеждения.
""",
            "fears_barriers": """
Проанализируй страхи и барьеры - эмоциональные препятствия.
""",
            "solution_expectations": """
Изучи ожидания от решения - представления о желаемом результате.
""",
            "desires_dreams": """
Проанализируй желания и мечты - идеальные сценарии "по щелчку пальцев".
"""
        }
    
    def process_stage(self, stage: str, input_data: Dict[str, Any]) -> Dict[str, Any]:
        """
        Обработка этапа фреймворка
        
        Args:
            stage: название этапа
            input_data: входные данные
        """
        if stage == "audit":
            return self._process_audit(input_data)
        elif stage in ["market", "niche", "audience", "segment", "pain", "task"]:
            return self._process_hypothesis_stage(stage, input_data)
        elif stage == "expansion":
            return self._process_expansion(input_data)
        else:
            raise ValueError(f"Unknown stage: {stage}")
    
    def _process_audit(self, data: Dict[str, Any]) -> Dict[str, Any]:
        """Обработка этапа аудита"""
        # Здесь будет логика обработки аудита
        return {
            "status": "completed",
            "data_categories": {},
            "quality_scores": {},
            "gaps": []
        }
    
    def _process_hypothesis_stage(self, stage: str, data: Dict[str, Any]) -> Dict[str, Any]:
        """Обработка этапа генерации гипотез"""
        return {
            "stage": stage,
            "hypotheses": [],
            "evaluation": {},
            "top_3": [],
            "final_choice": None
        }
    
    def _process_expansion(self, data: Dict[str, Any]) -> Dict[str, Any]:
        """Обработка этапа расширения аудитории"""
        return {
            "deep_insights": {},
            "language_patterns": {},
            "triggers": [],
            "motivations": {}
        }
